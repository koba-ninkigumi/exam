const SUBROOTFOLDER="SuperKFolder",ADMINURL="https://superk-exam.appspot.com/api/exam/pronunciation";function insertFile2(e,t,o,n){const i=t.get("audio"),s=i.type||"application/octet-stream",a=gapi.client.getToken().access_token,l=new XMLHttpRequest;l.open("POST","https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",!0),l.setRequestHeader("Authorization","Bearer "+a),l.setRequestHeader("Content-Type","application/json"),l.setRequestHeader("X-Upload-Content-Length",i.size),l.setRequestHeader("X-Upload-Content-Type",s),l.onreadystatechange=function(){if(l.readyState===XMLHttpRequest.DONE&&200===l.status){const e=l.getResponseHeader("Location"),t=new FileReader;t.onload=(o=>{const i=new XMLHttpRequest;i.open("PUT",e,!0),i.setRequestHeader("Content-Type",s),i.setRequestHeader("X-Upload-Content-Type",s),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(console.log(i.response),n(JSON.parse(i.response)))},i.send(t.result)}),t.readAsArrayBuffer(i)}},l.send(JSON.stringify({name:i.name,parents:[o],mimeType:s,"Content-Type":s,"Content-Length":i.size}))}function uploadFile(e){gapi.client.load("drive","v2",()=>{retrieveAllFiles(t=>{const o=gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();if(console.log(t),0===t.length)createFolder(t=>{console.log(t),insertFile2(e.get("audio").name,e,t.id,e=>{insertPermission(e.id,()=>{console.log(e);const t={url:"https://drive.google.com/file/d/"+e.id+"/view?usp=sharing",name:o.getName(),email:o.getEmail()};postWebLink(ADMINURL,t)})})});else{const n=t.filter(e=>"application/vnd.google-apps.folder"==e.mimeType&&e.title==SUBROOTFOLDER)[0];console.log(n),insertFile2(e.get("audio").name,e,n.id,e=>{insertPermission(e.id,()=>{console.log(e);const t={url:"https://drive.google.com/file/d/"+e.id+"/view?usp=sharing",name:o.getName(),email:o.getEmail()};postWebLink(ADMINURL,t)})})}})})}function insertPermission(e,t){console.log(e);t||(t=(e=>{console.log(e)})),gapi.client.drive.permissions.insert({fileId:e,resource:{type:"anyone",role:"reader",withLink:!0}}).execute(t)}function createFolder(e){e||(e=(e=>{console.log(e),console.log(e.id),console.log(e.title)})),gapi.client.request({path:"/drive/v2/files",method:"POST",headers:{"Content-Type":"application/json"},body:{title:SUBROOTFOLDER,mimeType:"application/vnd.google-apps.folder"}}).execute(e)}function retrieveAllFiles(e){let t=(o,n)=>{o.execute(i=>{n=n.concat(i.items);const s=i.nextPageToken;s?(o=gapi.client.drive.files.list({pageToken:s}),t(o,n)):e(n)})};const o=gapi.client.drive.files.list();t(o,[])}function postWebLink(e,t){fetch(e,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{console.log(e)})}function onSignIn(e){document.querySelector(".g-signin2").style.display="none",document.querySelector(".g-signout").style.display="block",document.querySelector("#audiomain").style.display="block";const t=e.getBasicProfile();console.log("ID: "+t.getId()),console.log("Full Name: "+t.getName()),console.log("Given Name: "+t.getGivenName()),console.log("Family Name: "+t.getFamilyName()),console.log("Image URL: "+t.getImageUrl()),console.log("Email: "+t.getEmail());var o=e.getAuthResponse().id_token;console.log("ID Token: "+o)}function signOut(){document.querySelector(".g-signout").style.display="none",document.querySelector("#audiomain").style.display="none",document.querySelector(".g-signin2").style.display="block",gapi.auth2.getAuthInstance().signOut().then(function(){console.log("User signed out.")})}var recordButton,stopButton,recorder;function startRecording(){recordButton.disabled=!0,stopButton.disabled=!1,recordButton.style.display="none",stopButton.style.display="block",recorder.start()}function stopRecording(){recordButton.disabled=!1,stopButton.disabled=!0,stopButton.style.display="none",recordButton.style.display="block",recorder.stop(),recorder.stream.getTracks().forEach(e=>e.stop()),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{(recorder=new MediaRecorder(e)).addEventListener("dataavailable",onRecordingReady)})}function onRecordingReady(e){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",o=[...Array(8).keys()].map(e=>t.charAt(Math.floor(Math.random()*t.length))).reduce((e,t)=>e+t);let n=new FormData;n.append("audio",e.data,"audio_"+o+"."+e.data.type.split("/")[1]),console.log(e.data),console.log(n.get("audio"));let i=document.getElementById("audio");i.src=URL.createObjectURL(e.data),i.play(),uploadFile(n)}window.onload=(()=>{recordButton=document.getElementById("record"),(stopButton=document.getElementById("stop")).style.display="none",navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{recordButton.disabled=!1,recordButton.addEventListener("click",startRecording),stopButton.addEventListener("click",stopRecording),(recorder=new MediaRecorder(e)).addEventListener("dataavailable",onRecordingReady)})});